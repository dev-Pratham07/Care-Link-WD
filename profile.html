<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - Care Link</title>
  <link rel="stylesheet" href="css/styles.css">
  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .profile-container {
      min-height: 100vh;
      padding: 6rem 2rem 2rem;
      background: linear-gradient(135deg, hsl(var(--primary) / 0.05) 0%, hsl(var(--secondary) / 0.05) 100%);
    }

    .profile-card {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .profile-header {
      background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--secondary)) 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      font-size: 2.5rem;
      font-weight: bold;
      color: hsl(var(--primary));
    }

    .profile-body {
      padding: 2rem;
    }

    .profile-section {
      margin-bottom: 2rem;
    }

    .profile-section h3 {
      color: hsl(var(--text));
      margin-bottom: 1rem;
      font-size: 1.25rem;
    }

    .profile-info {
      display: grid;
      gap: 1rem;
    }

    .info-item {
      display: flex;
      padding: 1rem;
      background: hsl(var(--background));
      border-radius: 8px;
      align-items: center;
    }

    .info-label {
      font-weight: 600;
      color: hsl(var(--text) / 0.7);
      min-width: 120px;
    }

    .info-value {
      color: hsl(var(--text));
      flex: 1;
    }

    .btn-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .logout-btn {
      background: hsl(var(--error));
      color: rgb(233, 28, 28);
    }

    .logout-btn:hover {
      background: hsl(var(--error) / 0.9);
    }

    .loading-spinner {
      text-align: center;
      padding: 3rem;
      color: hsl(var(--text) / 0.6);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid hsl(var(--primary) / 0.2);
      border-top-color: hsl(var(--primary));
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid hsl(var(--text) / 0.2);
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: hsl(var(--primary));
      box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <div class="profile-card">
      <div id="loadingState" class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading profile...</p>
      </div>

      <div id="profileContent" style="display: none;">
        <div class="profile-header">
          <div class="profile-avatar" id="avatarInitials">
            <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <h1 id="profileName">User Profile</h1>
          <p id="profileEmail" style="opacity: 0.9; margin-top: 0.5rem;"></p>
        </div>

        <div class="profile-body">
          <div class="profile-section">
            <h3>Account Information</h3>
            <div class="profile-info">
              <div class="info-item">
                <span class="info-label">Email:</span>
                <span class="info-value" id="infoEmail">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">User ID:</span>
                <span class="info-value" id="infoUserId">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Account Created:</span>
                <span class="info-value" id="infoCreated">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Email Confirmed:</span>
                <span class="info-value" id="infoConfirmed">-</span>
              </div>
            </div>
          </div>

          <div class="profile-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="margin: 0;">Personal Information</h3>
              <button id="editPersonalBtn" class="btn btn-sm btn-secondary">
                <svg class="icon" style="width: 14px; height: 14px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Edit
              </button>
            </div>
            <div class="profile-info" id="personalInfoDisplay">
              <div class="info-item">
                <span class="info-label">Full Name:</span>
                <span class="info-value" id="displayFullName">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Phone Number:</span>
                <span class="info-value" id="displayPhone">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Date of Birth:</span>
                <span class="info-value" id="displayDOB">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Gender:</span>
                <span class="info-value" id="displayGender">-</span>
              </div>
            </div>
            <div id="personalInfoEdit" style="display: none;">
              <div style="display: grid; gap: 1rem;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Full Name</label>
                  <input type="text" id="editFullName" class="form-input" placeholder="John Doe">
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Phone Number</label>
                  <input type="tel" id="editPhone" class="form-input" placeholder="1234567890 (10 digits)">
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Date of Birth</label>
                  <input type="date" id="editDOB" class="form-input">
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Gender</label>
                  <select id="editGender" class="form-input">
                    <option value="">Select...</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                    <option value="prefer_not_to_say">Prefer not to say</option>
                  </select>
                </div>
                <div class="btn-group" style="margin-top: 1rem;">
                  <button id="savePersonalBtn" class="btn btn-primary">Save Changes</button>
                  <button id="cancelPersonalBtn" class="btn btn-secondary">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <div class="profile-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="margin: 0;">Medical Information</h3>
              <button id="editMedicalBtn" class="btn btn-sm btn-secondary">
                <svg class="icon" style="width: 14px; height: 14px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Edit
              </button>
            </div>
            <div class="profile-info" id="medicalInfoDisplay">
              <div class="info-item">
                <span class="info-label">Blood Group:</span>
                <span class="info-value" id="displayBloodGroup">Not set</span>
              </div>
              <div class="info-item">
                <span class="info-label">Allergies:</span>
                <span class="info-value" id="displayAllergies">None listed</span>
              </div>
              <div class="info-item">
                <span class="info-label">Chronic Conditions:</span>
                <span class="info-value" id="displayConditions">None listed</span>
              </div>
            </div>
            <div id="medicalInfoEdit" style="display: none;">
              <div style="display: grid; gap: 1rem;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Blood Group</label>
                  <select id="editBloodGroup" class="form-input">
                    <option value="">Select...</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                  </select>
                  <small style="color: hsl(var(--text) / 0.6);">Important for emergency medical situations.</small>
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Allergies</label>
                  <textarea id="editAllergies" class="form-input" rows="3" placeholder="List any allergies (e.g., penicillin, peanuts, latex)&#10;Separate with commas"></textarea>
                  <small style="color: hsl(var(--text) / 0.6);">This information helps the AI provide safer health recommendations.</small>
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Chronic Conditions</label>
                  <textarea id="editConditions" class="form-input" rows="3" placeholder="List any chronic conditions (e.g., diabetes, hypertension, asthma)&#10;Separate with commas"></textarea>
                  <small style="color: hsl(var(--text) / 0.6);">This helps provide personalized health advice.</small>
                </div>
                <div class="btn-group" style="margin-top: 1rem;">
                  <button id="saveMedicalBtn" class="btn btn-primary">Save Changes</button>
                  <button id="cancelMedicalBtn" class="btn btn-secondary">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Health Records Section -->
          <div class="profile-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="margin: 0;">Health Records</h3>
            </div>
            <div id="healthRecordsList" class="profile-info">
              <div class="info-item" style="color: hsl(var(--text)/0.6);">Loading records...</div>
            </div>
          </div>

          <!-- My Reviews Section -->
          <div class="profile-section">
            <h3 style="margin-bottom: 1rem;">My Reviews</h3>
            <div id="myReviewsList" class="profile-info">
              <div class="info-item" style="color: hsl(var(--text)/0.6);">Loading reviews...</div>
            </div>
          </div>

          <div class="profile-section">
            <h3>Quick Actions</h3>
            <div class="btn-group">
              <a href="index.html" class="btn btn-primary">
                <svg class="icon" style="width: 16px; height: 16px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Go to Home
              </a>
              <a href="diagnostics.html" class="btn btn-secondary">
                <svg class="icon" style="width: 16px; height: 16px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
                Health Diagnostics
              </a>
            </div>
          </div>

          <div class="profile-section" style="border-top: 1px solid hsl(var(--text) / 0.1); padding-top: 2rem;">
            <h3 style="color: hsl(var(--error));">Account Management</h3>
            <div class="btn-group">
              <button id="logoutBtn" class="btn logout-btn" style="flex: 1;">
                <svg class="icon" style="width: 16px; height: 16px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                  <polyline points="16 17 21 12 16 7"></polyline>
                  <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Sign Out
              </button>
            </div>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: hsl(var(--text) / 0.6);">
              You'll be logged out and redirected to the home page.
            </p>
          </div>
        </div>
      </div>

      <div id="errorState" style="display: none; padding: 2rem; text-align: center;">
        <p style="color: hsl(var(--error)); margin-bottom: 1rem;">Unable to load profile. Please log in.</p>
        <a href="login.html" class="btn btn-primary">Go to Login</a>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/icons.js"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/navigation.js"></script>
  <script>
    // Profile Page Logic
    let currentUser = null;
    let currentProfile = null;

    async function loadProfile() {
      const loadingState = document.getElementById('loadingState');
      const profileContent = document.getElementById('profileContent');
      const errorState = document.getElementById('errorState');

      try {
        // Initialize Supabase
        initSupabase();

        // Get current user
        currentUser = await SupabaseAuth.getCurrentUser();
        
        if (!currentUser) {
          throw new Error('No user found');
        }

        // Get user profile from database
        try {
          currentProfile = await SupabaseDB.getProfile(currentUser.id);
        } catch (error) {
          console.warn('Profile not found in database, using auth data:', error);
          currentProfile = {
            id: currentUser.id,
            email: currentUser.email,
            full_name: currentUser.user_metadata?.full_name || '',
            phone_number: currentUser.user_metadata?.phone_number || '',
            date_of_birth: null,
            gender: null,
            allergies: [],
            chronic_conditions: []
          };
        }

        // Display user information
        displayUserInfo(currentUser, currentProfile);

        // Load additional data (Health Records, Reviews)
        loadAdditionalData(currentUser.id);

        // Show profile content
        loadingState.style.display = 'none';
        profileContent.style.display = 'block';

        // Attach event listeners for edit functionality
        attachEditListeners();

      } catch (error) {
        console.error('Error loading profile:', error);
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
      }
    }

    async function loadAdditionalData(userId) {
      // Health Records
      try {
        const records = await SupabaseDB.getHealthRecords(userId);
        const list = document.getElementById('healthRecordsList');
        
        if (records && records.length > 0) {
          list.innerHTML = records.map(record => `
            <div class="info-item" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; justify-content: space-between; width: 100%;">
                <span style="font-weight: 600;">${record.title}</span>
                <span style="font-size: 0.8rem; opacity: 0.7;">${new Date(record.uploaded_at || record.created_at).toLocaleDateString()}</span>
              </div>
              <p style="margin: 0.5rem 0 0; font-size: 0.9rem;">${record.description || 'No description'}</p>
              ${record.file_url ? `<a href="${record.file_url}" target="_blank" style="margin-top: 0.5rem; color: hsl(var(--primary)); font-size: 0.8rem;">View Document</a>` : ''}
            </div>
          `).join('');
        } else {
          list.innerHTML = '<div class="info-item" style="opacity: 0.7;">No health records found.</div>';
        }
      } catch (e) {
        console.error('Error loading health records:', e);
        document.getElementById('healthRecordsList').innerHTML = '<div class="info-item" style="color: hsl(var(--error));">Failed to load health records.</div>';
      }

      // Reviews
      try {
        const reviews = await SupabaseDB.getUserReviews(userId);
        const list = document.getElementById('myReviewsList');
        
        if (reviews && reviews.length > 0) {
          list.innerHTML = reviews.map(review => `
            <div class="info-item" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <div style="display: flex;">${getStarRatingHTML(review.rating)}</div>
                <span style="font-size: 0.8rem; opacity: 0.7;">${new Date(review.created_at).toLocaleDateString()}</span>
              </div>
              <p style="margin: 0; font-size: 0.9rem; font-style: italic;">"${review.comment}"</p>
            </div>
          `).join('');
        } else {
          list.innerHTML = '<div class="info-item" style="opacity: 0.7;">You haven\'t left any reviews yet.</div>';
        }
      } catch (e) {
        console.error('Error loading reviews:', e);
        document.getElementById('myReviewsList').innerHTML = '<div class="info-item" style="color: hsl(var(--error));">Failed to load reviews.</div>';
      }
    }

    function getStarRatingHTML(rating) {
      let html = '';
      for (let i = 0; i < 5; i++) {
        const fill = i < rating ? 'currentColor' : 'none';
        const color = i < rating ? 'hsl(var(--primary))' : 'hsl(var(--text)/0.2)';
        html += `<svg width="14" height="14" viewBox="0 0 24 24" fill="${fill}" stroke="${color}" stroke-width="2" style="margin-right: 2px;">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-5.82 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
        </svg>`;
      }
      return html;
    }

    function displayUserInfo(user, profile) {
      // Get initials for avatar
      const email = user.email || '';
      const initials = email.charAt(0).toUpperCase();
      
      // Update avatar
      const avatarInitials = document.getElementById('avatarInitials');
      if (profile.full_name) {
        const nameParts = profile.full_name.split(' ');
        const initialsText = nameParts.map(part => part.charAt(0)).join('').toUpperCase().slice(0, 2);
        avatarInitials.textContent = initialsText;
      } else {
        avatarInitials.textContent = initials;
      }

      // Update header
      document.getElementById('profileName').textContent = profile.full_name || 'User Profile';
      document.getElementById('profileEmail').textContent = email;

      // Update account info
      document.getElementById('infoEmail').textContent = email;
      document.getElementById('infoUserId').textContent = user.id;
      
      const createdDate = new Date(user.created_at);
      document.getElementById('infoCreated').textContent = createdDate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      const confirmedStatus = document.getElementById('infoConfirmed');
      if (user.email_confirmed_at) {
        confirmedStatus.textContent = '✓ Verified';
        confirmedStatus.style.color = 'hsl(var(--success))';
      } else {
        confirmedStatus.textContent = '✗ Not verified';
        confirmedStatus.style.color = 'hsl(var(--error))';
      }

      // Update personal info
      document.getElementById('displayFullName').textContent = profile.full_name || 'Not set';
      document.getElementById('displayPhone').textContent = profile.phone_number || 'Not set';
      document.getElementById('displayDOB').textContent = profile.date_of_birth 
        ? new Date(profile.date_of_birth).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
        : 'Not set';
      document.getElementById('displayGender').textContent = profile.gender 
        ? profile.gender.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())
        : 'Not set';

      // Update medical info
      document.getElementById('displayBloodGroup').textContent = profile.blood_group || 'Not set';
      document.getElementById('displayAllergies').textContent = 
        (profile.allergies && profile.allergies.length > 0) ? profile.allergies.join(', ') : 'None listed';
      document.getElementById('displayConditions').textContent = 
        (profile.chronic_conditions && profile.chronic_conditions.length > 0) ? profile.chronic_conditions.join(', ') : 'None listed';
    }

    function attachEditListeners() {
      // Personal Info Edit
      document.getElementById('editPersonalBtn').addEventListener('click', () => {
        document.getElementById('personalInfoDisplay').style.display = 'none';
        document.getElementById('personalInfoEdit').style.display = 'block';
        
        // Populate form
        document.getElementById('editFullName').value = currentProfile.full_name || '';
        document.getElementById('editPhone').value = currentProfile.phone_number || '';
        document.getElementById('editDOB').value = currentProfile.date_of_birth || '';
        document.getElementById('editGender').value = currentProfile.gender || '';
      });

      document.getElementById('cancelPersonalBtn').addEventListener('click', () => {
        document.getElementById('personalInfoDisplay').style.display = 'block';
        document.getElementById('personalInfoEdit').style.display = 'none';
      });

      document.getElementById('savePersonalBtn').addEventListener('click', async () => {
        const saveBtn = document.getElementById('savePersonalBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
          const updates = {
            full_name: document.getElementById('editFullName').value.trim(),
            phone_number: document.getElementById('editPhone').value.trim(),
            date_of_birth: document.getElementById('editDOB').value || null,
            gender: document.getElementById('editGender').value || null
          };

          await SupabaseDB.updateProfile(currentUser.id, updates);
          
          // Update local profile
          currentProfile = { ...currentProfile, ...updates };
          
          // Refresh display
          displayUserInfo(currentUser, currentProfile);
          
          // Switch back to display mode
          document.getElementById('personalInfoDisplay').style.display = 'block';
          document.getElementById('personalInfoEdit').style.display = 'none';
          
          alert('Personal information updated successfully!');
        } catch (error) {
          console.error('Error updating profile:', error);
          alert(`Failed to update profile: ${error.message || JSON.stringify(error)}`);
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Changes';
        }
      });

      // Medical Info Edit
      document.getElementById('editMedicalBtn').addEventListener('click', () => {
        document.getElementById('medicalInfoDisplay').style.display = 'none';
        document.getElementById('medicalInfoEdit').style.display = 'block';
        
        // Populate form
        document.getElementById('editBloodGroup').value = currentProfile.blood_group || '';
        document.getElementById('editAllergies').value = 
          (currentProfile.allergies && currentProfile.allergies.length > 0) 
            ? currentProfile.allergies.join(', ') 
            : '';
        document.getElementById('editConditions').value = 
          (currentProfile.chronic_conditions && currentProfile.chronic_conditions.length > 0) 
            ? currentProfile.chronic_conditions.join(', ') 
            : '';
      });

      document.getElementById('cancelMedicalBtn').addEventListener('click', () => {
        document.getElementById('medicalInfoDisplay').style.display = 'block';
        document.getElementById('medicalInfoEdit').style.display = 'none';
      });

      document.getElementById('saveMedicalBtn').addEventListener('click', async () => {
        const saveBtn = document.getElementById('saveMedicalBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
          // Parse comma-separated values into arrays
          const allergiesText = document.getElementById('editAllergies').value.trim();
          const conditionsText = document.getElementById('editConditions').value.trim();

          const updates = {
            blood_group: document.getElementById('editBloodGroup').value || null,
            allergies: allergiesText ? allergiesText.split(',').map(s => s.trim()).filter(s => s) : [],
            chronic_conditions: conditionsText ? conditionsText.split(',').map(s => s.trim()).filter(s => s) : []
          };

          await SupabaseDB.updateProfile(currentUser.id, updates);
          
          // Update local profile
          currentProfile = { ...currentProfile, ...updates };
          
          // Refresh display
          displayUserInfo(currentUser, currentProfile);
          
          // Switch back to display mode
          document.getElementById('medicalInfoDisplay').style.display = 'block';
          document.getElementById('medicalInfoEdit').style.display = 'none';
          
          alert('Medical information updated successfully!\n\nThis information will be used by the AI to provide personalized health recommendations.');
        } catch (error) {
          console.error('Error updating medical info:', error);
          alert(`Failed to update medical information: ${error.message || JSON.stringify(error)}`);
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Changes';
        }
      });
    }

    // Logout functionality
    document.addEventListener('DOMContentLoaded', () => {
      loadProfile();

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to sign out?')) {
          return;
        }

        try {
          const logoutBtn = document.getElementById('logoutBtn');
          const originalText = logoutBtn.innerHTML;
          logoutBtn.disabled = true;
          logoutBtn.innerHTML = '<span style="opacity: 0.6;">Signing out...</span>';

          await SupabaseAuth.signOut();
          localStorage.clear();
          window.location.href = 'login.html';
        } catch (error) {
          console.error('Logout error:', error);
          alert('Error signing out. Please try again.');
          
          const logoutBtn = document.getElementById('logoutBtn');
          logoutBtn.disabled = false;
          logoutBtn.innerHTML = originalText;
        }
      });
    });
  </script>
</body>
</html>
